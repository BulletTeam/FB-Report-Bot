<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Live Preview — Facebook Automation Tool</title>
<style>
  :root{
    --bg:#0f1724; --card:#0b1220; --muted:#9aa3b2; --accent:#1869ff; --danger:#ff4d4f;
    --success:#10b981; --glass: rgba(255,255,255,0.03); --radius:12px;
  }
  html,body{height:100%; margin:0; font-family: Inter, system-ui, "Segoe UI", Roboto, Arial; background:linear-gradient(180deg,#081028,#07121a); color:#e6eef8;}
  .wrap{max-width:1100px; margin:18px auto; padding:18px; display:grid; grid-template-columns: 420px 1fr; gap:18px;}
  .card{background:var(--card); border-radius:var(--radius); padding:14px; box-shadow:0 8px 36px rgba(2,6,23,0.6); border:1px solid rgba(255,255,255,0.02);}
  input[type=text], input[type=password]{background:transparent; border:1px solid rgba(255,255,255,0.06); color:inherit; padding:8px 10px; border-radius:8px; min-width:160px;}
  button{background:var(--accent); color:#fff; border:0; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700;}
  button.secondary{background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted);}
  .preview{display:flex; flex-direction:column; gap:10px; align-items:center;}
  .screenshot-box{width:380px; height:760px; background:#000; border-radius:8px; overflow:hidden; display:flex; align-items:center; justify-content:center; border:1px solid rgba(255,255,255,0.03);}
  .screenshot-box img{max-width:100%; max-height:100%; display:block; object-fit:contain;}
  .meta{width:100%; display:flex; gap:8px; flex-direction:column;}
  .field{display:flex; gap:8px; align-items:center; justify-content:space-between; padding:8px; border-radius:8px; background:var(--glass); font-size:13px;}
  .small{font-size:12px; color:var(--muted);}
  .log-area{height:580px; overflow:auto; background:rgba(0,0,0,0.15); border-radius:8px; padding:10px; font-family:monospace; font-size:13px; color:#cfefff;}
  .log-line{padding:6px 8px; border-radius:6px; margin-bottom:6px;}
  .log-line.info{background: rgba(20,40,80,0.35); color:#dbeafe;}
  .log-line.warn{background: rgba(85,60,0,0.25); color:#ffda7a;}
  .log-line.error{background: rgba(100,0,0,0.3); color:#ffd6d6;}
  .log-line.success{background: rgba(0,50,0,0.25); color:#bbf7d0;}
  .current{font-weight:800; font-size:14px; color:#fff;}
  .tiny{font-size:12px; color:var(--muted);}
  .status-pill{padding:6px 8px; border-radius:999px; font-weight:800; font-size:12px;}
  .status-live{background:rgba(16,185,129,0.12); color:var(--success); border:1px solid rgba(16,185,129,0.14);}
  .status-idle{background:rgba(255,255,255,0.03); color:var(--muted); border:1px solid rgba(255,255,255,0.02);}
  .row{display:flex; gap:8px; align-items:center;}
  .timeline{display:flex; flex-direction:column; gap:6px;}
  .timeline-item{font-size:13px; color:#dbeafe; padding:8px; border-radius:8px; background: rgba(255,255,255,0.02);}
  footer{text-align:center; color:var(--muted); margin-top:12px; grid-column:1/-1;}
  @media(max-width:980px){ .wrap{grid-template-columns:1fr; padding:12px} .screenshot-box{width:260px; height:520px} .log-area{height:420px} }
</style>
</head>
<body>
  <div class="wrap">
    <!-- LEFT -->
    <div class="card preview" aria-live="polite">
      <div style="width:100%; display:flex; justify-content:space-between; align-items:center;">
        <div style="font-weight:900; font-size:16px">Live Browser Preview</div>
        <div class="row"><div id="connStatus" class="tiny status-pill status-idle">disconnected</div></div>
      </div>

      <div class="screenshot-box">
        <div id="placeholder" style="text-align:center; color:var(--muted); padding:12px;">
          No frames yet.<br><span class="tiny">Connect with admin token & session id above</span>
        </div>
        <img id="screenshotImg" alt="Live screenshot" style="display:none" />
      </div>

      <div class="meta">
        <div class="field">
          <div><div class="tiny">Current URL</div><div id="curUrl" class="current">-</div></div>
          <div id="urlTime" class="tiny">--:--:--</div>
        </div>
        <div class="field">
          <div><div class="tiny">Current Activity</div><div id="curAction" class="current">idle</div></div>
          <div style="text-align:right"><div class="tiny">Last step result</div><div id="curResult" class="tiny">-</div></div>
        </div>
        <div class="row">
          <input id="adminToken" type="password" placeholder="Admin token (x-admin-token)" />
          <input id="sessionId" type="text" placeholder="sessionId (default)" value="default" />
          <button id="connectBtn">Connect</button>
          <button id="disconnectBtn" class="secondary">Disconnect</button>
        </div>
        <div class="row" style="margin-top:8px;">
          <label class="tiny">Frame interval</label>
          <select id="frameInterval" title="How often to show frames">
            <option value="1000">1s</option><option value="2000" selected>2s</option><option value="3000">3s</option><option value="5000">5s</option>
          </select>
          <label class="tiny" style="margin-left:8px"><input id="autoFit" type="checkbox" checked /> Auto-fit image</label>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card" style="display:flex; flex-direction:column;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <div style="font-weight:900">Activity Log</div>
        <div class="tiny">Latest events from server</div>
      </div>
      <div class="log-area" id="logArea" role="log"></div>
      <div style="display:flex; gap:8px; margin-top:8px; align-items:center;">
        <button id="clearLogBtn" class="secondary">Clear Log</button>
        <div style="flex:1"></div>
        <div class="tiny">Auto-reconnect: <span id="autoReconnect">on</span></div>
      </div>
      <div style="margin-top:10px;">
        <div style="font-weight:800; margin-bottom:6px;">Recent timeline</div>
        <div class="timeline" id="timeline"></div>
      </div>
    </div>

    <footer class="card">Live preview uses SSE <code>/events</code>. Provide <code>x-admin-token</code> and sessionId. © 2025</footer>
  </div>

<script>
(() => {
  // Elements
  const adminInput = document.getElementById('adminToken');
  const sessionInput = document.getElementById('sessionId');
  const connectBtn = document.getElementById('connectBtn');
  const disconnectBtn = document.getElementById('disconnectBtn');
  const connStatus = document.getElementById('connStatus');
  const screenshotImg = document.getElementById('screenshotImg');
  const placeholder = document.getElementById('placeholder');
  const curUrl = document.getElementById('curUrl');
  const curAction = document.getElementById('curAction');
  const curResult = document.getElementById('curResult');
  const urlTime = document.getElementById('urlTime');
  const logArea = document.getElementById('logArea');
  const clearLogBtn = document.getElementById('clearLogBtn');
  const timeline = document.getElementById('timeline');
  const autoReconnect = document.getElementById('autoReconnect');
  const frameIntervalSel = document.getElementById('frameInterval');
  const autoFitChk = document.getElementById('autoFit');

  // State
  let es = null;
  let reconnecting = true;
  let reconnectAttempts = 0;
  let wantedInterval = Number(frameIntervalSel.value) || 2000;
  let lastRendered = 0;
  let lastScreenshot = null;
  let frameRenderTimer = null;
  const timelineItems = [];

  // Helpers
  const now = () => new Date().toLocaleTimeString();
  const setStatus = (txt, cls='status-idle') => { connStatus.textContent = txt; connStatus.className = 'tiny status-pill ' + cls; };
  function pushLog(text, level='info'){
    const el = document.createElement('div');
    el.className = 'log-line ' + (level==='warn'?'warn':level==='error'?'error':level==='success'?'success':'info');
    el.textContent = `[${now()}] ${text}`;
    logArea.appendChild(el);
    while (logArea.children.length > 400) logArea.removeChild(logArea.firstChild);
    logArea.scrollTop = logArea.scrollHeight;
  }
  function addTimeline(text){
    timelineItems.unshift({ t: now(), text });
    if (timelineItems.length > 8) timelineItems.pop();
    timeline.innerHTML = '';
    for (const it of timelineItems){
      const d = document.createElement('div');
      d.className = 'timeline-item';
      d.innerHTML = `<div style="font-weight:700">${it.text}</div><div class="tiny" style="margin-top:4px">${it.t}</div>`;
      timeline.appendChild(d);
    }
  }
  const safeParse = (s) => { try { return JSON.parse(s); } catch { return null; } };

  // Connect SSE
  function connect(){
    const token = adminInput.value.trim();
    const sid = sessionInput.value.trim() || 'default';
    if (!token){ alert('Provide admin token (x-admin-token)'); return; }

    disconnect(); // close previous

    const url = `/events?sessionId=${encodeURIComponent(sid)}&adminToken=${encodeURIComponent(token)}`;
    pushLog(`Connecting SSE -> ${url}`);
    setStatus('connecting...', 'status-idle');

    try { es = new EventSource(url); } catch (e) {
      pushLog('EventSource init failed: ' + (e && e.message), 'error');
      scheduleReconnect(); return;
    }

    es.onopen = () => { reconnectAttempts = 0; setStatus('connected', 'status-live'); pushLog('SSE open'); };

    // Core named events
    const names = ['log','info','warn','error','done','success','fatal','cookieStatus','screenshot'];
    names.forEach(name => {
      es.addEventListener(name, (evt) => {
        if (name === 'screenshot'){
          // Expect {data: "<base64>", timestamp}
          const payload = safeParse(evt.data);
          const base64 = payload && payload.data ? payload.data : (typeof evt.data === 'string' ? evt.data : '');
          handleScreenshot(base64);
          // No base64 logs — keep UI clean
          return;
        }

        const payload = safeParse(evt.data) ?? evt.data;

        // Update some UI hints from info logs
        if (name==='info' || name==='log' || name==='warn' || name==='error'){
          if (payload && typeof payload === 'object'){
            if (payload.url){ curUrl.textContent = payload.url; urlTime.textContent = now(); addTimeline('URL → ' + payload.url); }
            if (payload.step){ curAction.textContent = payload.step; addTimeline('Action → ' + payload.step); }
            if (payload.ok || payload.reason || payload.detail){
              curResult.textContent = payload.reason || (payload.detail ? JSON.stringify(payload.detail) : (payload.ok?'ok':''));
            }
          }
        }

        // Light log message (without huge data)
        const lvl = name==='warn'?'warn':name==='error'?'error':name==='fatal'?'error':name==='success'?'success':'info';
        pushLog(`[${name}] ${typeof payload==='string'?payload:JSON.stringify(payload)}`, lvl);
      });
    });

    es.onerror = () => {
      pushLog('SSE error / closed', 'warn');
      setStatus('disconnected','status-idle');
      try { es.close(); } catch {}
      es = null;
      scheduleReconnect();
    };
  }

  function disconnect(){
    if (es){ try { es.close(); } catch{} es = null; pushLog('SSE disconnected by user'); setStatus('disconnected','status-idle'); }
  }

  // Screenshot handling
  function handleScreenshot(b64){
    if (!b64) return;
    const nowTs = Date.now();
    if (nowTs - lastRendered < wantedInterval){ lastScreenshot = b64; return; }
    lastRendered = nowTs;
    lastScreenshot = b64;
    renderScreenshot(b64);
  }

  function renderScreenshot(b64){
    const dataUrl = 'data:image/png;base64,' + b64;
    screenshotImg.src = dataUrl;
    screenshotImg.style.display = 'block';
    if (placeholder) placeholder.style.display = 'none';
    if (autoFitChk.checked){ screenshotImg.style.width = '100%'; screenshotImg.style.height = 'auto'; }
    else { screenshotImg.style.width = ''; screenshotImg.style.height = ''; screenshotImg.style.maxWidth = '100%'; screenshotImg.style.maxHeight = '100%'; }
  }

  function startFramePump(){
    if (frameRenderTimer) clearInterval(frameRenderTimer);
    frameRenderTimer = setInterval(() => {
      if (lastScreenshot){ renderScreenshot(lastScreenshot); lastScreenshot = null; }
    }, Math.max(200, wantedInterval));
  }

  // Reconnect with backoff
  function scheduleReconnect(){
    if (!reconnecting) return;
    reconnectAttempts++;
    const backoff = Math.min(30000, 1000 * Math.pow(1.6, Math.min(reconnectAttempts, 8)));
    pushLog(`Reconnecting in ${Math.round(backoff/1000)}s (attempt ${reconnectAttempts})`, 'warn');
    setStatus('reconnecting...', 'status-idle');
    setTimeout(connect, backoff);
  }

  // UI bindings
  connectBtn.addEventListener('click', () => { reconnecting = true; autoReconnect.textContent = 'on'; connect(); });
  disconnectBtn.addEventListener('click', () => { reconnecting = false; autoReconnect.textContent = 'off'; disconnect(); });
  clearLogBtn.addEventListener('click', () => { logArea.innerHTML = ''; pushLog('Log cleared'); });
  frameIntervalSel.addEventListener('change', () => { wantedInterval = Number(frameIntervalSel.value) || 2000; startFramePump(); });
  autoFitChk.addEventListener('change', () => { /* size is set during render */ });

  // Init
  startFramePump();
  window.addEventListener('beforeunload', () => { reconnecting = false; disconnect(); });
  adminInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') connectBtn.click(); });
  sessionInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') connectBtn.click(); });

  // Debug expose + hint
  window.__livepreview = { connect, disconnect };
  pushLog('Live preview ready. Enter adminToken and sessionId (match the runner) then Connect.');
})();
</script>
</body>
</html>
