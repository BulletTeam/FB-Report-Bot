<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live Preview & Logs</title>
  <style>
    body { margin:0; display:flex; height:100vh; font-family:sans-serif; background:#111; color:#eee; }
    #left { width:250px; padding:10px; background:#222; box-sizing:border-box; }
    #center { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; }
    #right { width:350px; background:#000; color:#0f0; font-size:12px; overflow:auto; padding:5px; }
    button { margin:4px 0; padding:5px 10px; }
    img { max-width:100%; border:1px solid #444; border-radius:4px; background:#000; }
  </style>
</head>
<body>
  <div id="left">
    <h3>Controls</h3>
    <label>Admin token:<br><input id="token" type="text" style="width:100%" /></label><br>
    <label>Session ID:<br><input id="sid" value="default" style="width:100%" /></label><br>
    <button onclick="connectSSE()">Connect SSE</button>
    <button onclick="disconnectSSE()">Disconnect</button>
    <hr>
    <button onclick="startJob()">Start</button>
    <button onclick="stopJob()">Stop</button>
    <p>Current page:<br><span id="pageUrl">-</span></p>
  </div>

  <div id="center">
    <h3>Live Browser Preview</h3>
    <img id="liveShot" alt="(no screenshot yet)">
  </div>

  <div id="right" id="logs"></div>

<script>
let es = null;

function log(msg, type="log") {
  const box = document.getElementById("right");
  const line = document.createElement("div");
  line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
  line.style.color = type === "warn" ? "orange" : (type==="error"?"red":"#0f0");
  box.appendChild(line);
  box.scrollTop = box.scrollHeight;
}

function connectSSE() {
  disconnectSSE();
  const sid = document.getElementById("sid").value.trim() || "default";
  const token = document.getElementById("token").value.trim();
  es = new EventSource(`/events?sessionId=${encodeURIComponent(sid)}&adminToken=${encodeURIComponent(token)}`);
  
  es.addEventListener("ready", e=> log("SSE ready: "+e.data));
  es.addEventListener("log", e=> log("LOG "+e.data));
  es.addEventListener("warn", e=> log("WARN "+e.data,"warn"));
  es.addEventListener("error", e=> log("ERROR "+e.data,"error"));

  es.addEventListener("page-url", e=>{
    try { const d = JSON.parse(e.data); document.getElementById("pageUrl").textContent = d.url || e.data; } catch { document.getElementById("pageUrl").textContent=e.data; }
  });

  es.addEventListener("screenshot", e=>{
    try {
      const d = JSON.parse(e.data);
      if (d && d.b64) document.getElementById("liveShot").src = "data:image/png;base64,"+d.b64;
    } catch {}
  });

  log("Connecting SSEâ€¦");
}

function disconnectSSE() {
  if (es) { es.close(); es=null; log("SSE disconnected"); }
}

async function startJob() {
  const sid = document.getElementById("sid").value.trim() || "default";
  const token = document.getElementById("token").value.trim();
  const targetUrl = prompt("Enter target URL:");
  const res = await fetch("/start", {
    method:"POST", headers:{ "Content-Type":"application/json","x-admin-token":token },
    body: JSON.stringify({ sessionId:sid, targetUrl })
  });
  log("Start response: "+res.status);
}

async function stopJob() {
  const sid = document.getElementById("sid").value.trim() || "default";
  const token = document.getElementById("token").value.trim();
  await fetch("/stop", { method:"POST", headers:{ "Content-Type":"application/json","x-admin-token":token },
    body: JSON.stringify({ sessionId:sid }) });
  log("Stop requested");
}
</script>
</body>
</html>
