<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live Preview — Facebook Tool</title>
  <style>
    body{ font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto; padding:18px; background:#f4f7fb; color:#0f1724; }
    .wrap{ max-width:980px; margin:0 auto; }
    h1{ margin:0 0 12px 0; font-size:20px; }
    .controls{ display:flex; gap:8px; margin-bottom:12px; align-items:center; }
    .btn{ padding:8px 12px; border-radius:8px; border:0; cursor:pointer; }
    .live-img{ width:100%; max-height:640px; object-fit:contain; background:#000; border-radius:8px; display:block; margin-bottom:12px; }
    .log{ background:#000; color:#66ff99; padding:12px; height:220px; overflow:auto; border-radius:8px; font-family:monospace; white-space:pre-wrap; }
    .meta{ margin-bottom:8px; color:#666; font-size:13px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Live Browser Preview</h1>
    <div class="meta">This view receives screenshots (base64) and live logs from the server session.</div>
    <div class="controls">
      <input id="adminToken" placeholder="x-admin-token" style="padding:8px 10px; border-radius:8px; border:1px solid #ddd;" />
      <button id="connect" class="btn">Connect SSE</button>
      <button id="disconnect" class="btn">Disconnect</button>
      <span id="status" style="margin-left:8px;color:#333;"></span>
    </div>

    <img id="liveImg" class="live-img" src="" alt="Live screenshot will appear here" />
    <div style="display:flex; gap:12px;">
      <div style="flex:1">
        <div style="font-weight:800; margin-bottom:6px;">Live Log</div>
        <pre id="log" class="log">—</pre>
      </div>
      <div style="width:240px">
        <div style="font-weight:800; margin-bottom:6px;">Session</div>
        <input id="sessionId" placeholder="session id (default)" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ddd;" />
        <div style="margin-top:8px; font-size:13px; color:#666;">If not set, use 'default' or the session created on upload/start.</div>
      </div>
    </div>
  </div>

<script>
(() => {
  const connectBtn = document.getElementById('connect');
  const disconnectBtn = document.getElementById('disconnect');
  const liveImg = document.getElementById('liveImg');
  const logEl = document.getElementById('log');
  const statusEl = document.getElementById('status');
  const adminInput = document.getElementById('adminToken');
  const sessionInput = document.getElementById('sessionId');

  let es = null;
  function appendLog(s){
    logEl.textContent = (logEl.textContent === '—' ? '' : logEl.textContent + '\n') + s;
    logEl.scrollTop = logEl.scrollHeight;
  }

  connectBtn.addEventListener('click', () => {
    const token = adminInput.value.trim();
    if(!token) return alert('Enter admin token');
    const sid = sessionInput.value.trim() || 'default';
    const url = `/events?sessionId=${encodeURIComponent(sid)}&adminToken=${encodeURIComponent(token)}`;
    if (es) es.close();
    es = new EventSource(url);
    statusEl.textContent = 'connecting...';
    es.onopen = () => { statusEl.textContent = 'connected'; appendLog('[SSE] connected'); };
    es.onmessage = (m) => appendLog('[msg] ' + m.data);
    es.addEventListener('screenshot', (e) => {
      // data is base64 string (raw)
      try {
        const b64 = e.data;
        // if server wrapped as JSON, try parse; otherwise treat as raw base64
        let raw = b64;
        try { const j = JSON.parse(b64); if (j && j.b64) raw = j.b64; } catch(_){}
        liveImg.src = 'data:image/png;base64,' + raw;
      } catch (err) {
        appendLog('[screenshot] parse error: ' + err.message);
      }
    });
    // other useful logs
    ['log','info','warn','error','done','success','fatal','cookieStatus'].forEach(ev => {
      es.addEventListener(ev, (evt) => {
        try { const d = JSON.parse(evt.data); appendLog(`[${ev}] ${JSON.stringify(d)}`); } catch(_) { appendLog(`[${ev}] ${evt.data}`); }
      });
    });
    es.onerror = (e) => { appendLog('[SSE] error'); statusEl.textContent = 'error/closed'; };
  });

  disconnectBtn.addEventListener('click', () => {
    if (es) { es.close(); es = null; statusEl.textContent = 'disconnected'; appendLog('[SSE] disconnected'); }
  });

})();
</script>
</body>
</html>
