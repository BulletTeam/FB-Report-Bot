<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tool Live â€” Preview & Logs</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial; margin:0; background:#0f1720; color:#e6eef6}
  .wrap{display:grid;grid-template-columns:360px 1fr;gap:12px;padding:12px;height:100vh;box-sizing:border-box}
  .panel{background:#0b1220;border-radius:8px;padding:12px;box-shadow:0 6px 18px rgba(2,6,23,.6);overflow:auto}
  h2{margin:0 0 8px 0;font-size:14px}
  label{display:block;margin:6px 0 3px;color:#99a7bf;font-size:12px}
  input,button,select,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #162233;background:#07101a;color:#e6eef6}
  button{cursor:pointer}
  #screenshot{width:100%;height:auto;border-radius:6px;border:1px solid #122}
  .logs{font-family:monospace;font-size:12px;line-height:1.3;color:#cfe8ff;background:#071426;padding:8px;border-radius:6px;height:45vh;overflow:auto}
  .meta{font-size:13px;color:#bcd; margin-bottom:8px}
  .small{font-size:12px;color:#97a9bf}
  .controls{display:flex;gap:8px}
  .controls button{flex:1}
  .row{display:flex;gap:8px}
  .muted{color:#6f8599}
  .status-live{color:#5ee67a}
  .status-error{color:#ff7b7b}
</style>
</head>
<body>
<div class="wrap">
  <div class="panel">
    <h2>Connection & Controls</h2>

    <label>Admin token</label>
    <input id="adminToken" placeholder="Enter ADMIN_TOKEN" />

    <label>Session ID</label>
    <input id="sessionId" value="default" />

    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="btnConnect">Connect SSE</button>
      <button id="btnDisconnect">Disconnect</button>
    </div>

    <div style="height:8px"></div>

    <label>Start / Stop runner</label>
    <div class="controls">
      <button id="btnStart">Start</button>
      <button id="btnStop">Stop</button>
    </div>

    <div style="height:8px"></div>

    <label>Upload cookies (text)</label>
    <input id="fileCookies" type="file" accept=".txt" />
    <button id="btnUpload">Upload</button>

    <div style="height:12px"></div>

    <div class="meta">
      <div>Session: <span id="metaSession" class="muted">-</span></div>
      <div>Runner: <span id="metaRunning" class="muted">stopped</span></div>
      <div>Current page url: <span id="metaUrl" class="muted">-</span></div>
      <div>Last step: <span id="metaStep" class="muted">-</span></div>
      <div>Last event: <span id="metaEvent" class="muted">-</span></div>
    </div>
  </div>

  <div class="panel">
    <h2>Live Preview & Logs</h2>

    <div style="display:flex;gap:12px;">
      <div style="flex:0 0 420px">
        <img id="screenshot" src="" alt="live screenshot (base64)" />
        <div style="margin-top:8px" class="small muted">Preview (updates every ~3s if attached)</div>
      </div>

      <div style="flex:1;min-width:0">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <div style="flex:1">
            <input id="filter" placeholder="filter logs..." />
          </div>
          <div><button id="clearLogsBtn">Clear UI logs</button></div>
        </div>

        <div class="logs" id="logs"></div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const adminEl = document.getElementById('adminToken');
  const sessionEl = document.getElementById('sessionId');
  const btnConnect = document.getElementById('btnConnect');
  const btnDisconnect = document.getElementById('btnDisconnect');
  const btnStart = document.getElementById('btnStart');
  const btnStop = document.getElementById('btnStop');
  const btnUpload = document.getElementById('btnUpload');
  const fileCookies = document.getElementById('fileCookies');

  const metaSession = document.getElementById('metaSession');
  const metaRunning = document.getElementById('metaRunning');
  const metaUrl = document.getElementById('metaUrl');
  const metaStep = document.getElementById('metaStep');
  const metaEvent = document.getElementById('metaEvent');

  const logsEl = document.getElementById('logs');
  const screenshotEl = document.getElementById('screenshot');
  const filterEl = document.getElementById('filter');
  const clearLogsBtn = document.getElementById('clearLogsBtn');

  let es = null;
  let connected = false;
  let uiLogs = [];

  function addLog(level, msg, obj){
    const ts = new Date().toLocaleTimeString();
    const line = { ts, level, msg, obj };
    uiLogs.push(line);
    renderLogs();
  }
  function renderLogs(){
    const f = (filterEl.value || '').toLowerCase().trim();
    const items = uiLogs.filter(it => !f || (it.msg + JSON.stringify(it.obj||'')).toLowerCase().includes(f));
    logsEl.innerHTML = items.slice(-1000).map(it => {
      const color = it.level==='error' ? 'status-error' : (it.level==='warn' ? 'status-error' : 'muted');
      return `<div><span class="small muted">[${it.ts}]</span> <strong>${it.msg}</strong> <span class="${color}">${it.level}</span><div style="font-size:11px;color:#9fb6d0">${it.obj ? JSON.stringify(it.obj) : ''}</div></div>`;
    }).join('');
    logsEl.scrollTop = logsEl.scrollHeight;
  }

  clearLogsBtn.onclick = () => { uiLogs = []; renderLogs(); };

  function sseConnect(){
    if (!adminEl.value) return alert('Admin token required');
    if (es) try{ es.close(); }catch(_){}
    const sid = encodeURIComponent(sessionEl.value || 'default');
    const token = encodeURIComponent(adminEl.value);
    const url = `/events?sessionId=${sid}&adminToken=${token}`;
    es = new EventSource(url, { withCredentials: true });
    metaSession.textContent = sid;
    addLog('info','SSE connecting',{url});
    es.addEventListener('open', ()=> {
      connected = true;
      addLog('info','SSE open', {});
    });
    es.addEventListener('ready', (ev) => {
      try { const d = JSON.parse(ev.data); addLog('info','ready',d); metaEvent.textContent = 'ready'; }
      catch(e){}
    });
    es.addEventListener('log', (ev) => {
      try { const d = JSON.parse(ev.data); addLog('log', d.step ? `step: ${d.step}` : (d.msg||'log'), d); if (d.msg==='page-url' && d.url) metaUrl.textContent = d.url; if(d.step) metaStep.textContent = d.step; metaEvent.textContent='log'; }
      catch(e){}
    });
    es.addEventListener('info', (ev)=> { try{ const d=JSON.parse(ev.data); addLog('info', d.msg||'info', d); metaEvent.textContent='info'; if(d.msg==='page-url' && d.url) metaUrl.textContent = d.url; }catch(e){}});
    es.addEventListener('warn', (ev)=> { try{ const d=JSON.parse(ev.data); addLog('warn', d.step ? `warn: ${d.step}` : (d.msg||'warn'), d); metaEvent.textContent='warn'; }catch(e){}});
    es.addEventListener('error', (ev)=> { try{ const d=JSON.parse(ev.data); addLog('error', d.msg||'error', d); metaEvent.textContent='error'; if(d.account) addLog('error', 'account-error', d.account); }catch(e){}});
    es.addEventListener('cookieStatus', (ev)=> { try{ const d=JSON.parse(ev.data); addLog('cookie', d.status, d); metaEvent.textContent='cookieStatus'; }catch(e){}});
    es.addEventListener('screenshot', (ev)=> {
      try {
        const d = JSON.parse(ev.data);
        if (d && d.b64) {
          screenshotEl.src = 'data:image/png;base64,' + d.b64;
          addLog('info','screenshot', { ts: d.ts });
          metaEvent.textContent='screenshot';
        }
      } catch(e) { addLog('warn','screenshot-parse-error',{}); }
    });
    es.onerror = (e) => {
      addLog('error','SSE error',e);
      connected = false;
    };
  }

  function sseDisconnect(){
    if (es) try { es.close(); addLog('info','SSE closed'); } catch(_) {}
    es = null;
    connected = false;
  }

  btnConnect.onclick = sseConnect;
  btnDisconnect.onclick = sseDisconnect;

  async function postJson(path, body){
    if (!adminEl.value) return alert('Admin token required');
    const token = adminEl.value;
    try {
      const res = await fetch(path, {
        method:'POST',
        headers: { 'Content-Type':'application/json', 'x-admin-token': token },
        body: JSON.stringify(body || {})
      });
      const json = await res.json();
      addLog('info', 'POST:'+path, json);
      return json;
    } catch (e) { addLog('error','post-failed',{path,e: String(e)}); return null; }
  }

  btnStart.onclick = async () => {
    const target = prompt('Target URL (e.g. https://m.facebook.com/... )','');
    if (!target) return;
    const setType = prompt('setType (profile/page/post)','profile');
    const body = { targetUrl: target, setType, sessionId: sessionEl.value || 'default' };
    const r = await postJson('/start', body);
    if (r && r.ok) metaRunning.textContent = 'running';
  };

  btnStop.onclick = async () => {
    const r = await postJson('/stop', { sessionId: sessionEl.value || 'default' });
    if (r && r.ok) metaRunning.textContent = 'stopped';
  };

  btnUpload.onclick = async () => {
    if (!fileCookies.files || fileCookies.files.length===0) return alert('select cookies txt');
    const f = fileCookies.files[0];
    const form = new FormData();
    form.append('cookies', f);
    form.append('sessionId', sessionEl.value || 'default');
    const token = adminEl.value;
    try {
      const res = await fetch('/uploadCookies?sessionId=' + encodeURIComponent(sessionEl.value||'default'), {
        method: 'POST',
        headers: { 'x-admin-token': token },
        body: form
      });
      const j = await res.json();
      addLog('info','uploadCookies', j);
      alert('Upload response: ' + JSON.stringify(j));
    } catch (e) {
      addLog('error','upload-failed',{err:String(e)});
      alert('Upload failed: ' + e);
    }
  };

  // auto-connect if token present in querystring
  (function autoConnectFromQS(){
    try {
      const params = new URLSearchParams(location.search);
      if (params.get('adminToken')) adminEl.value = params.get('adminToken');
      if (params.get('sessionId')) sessionEl.value = params.get('sessionId');
      if (adminEl.value) {
        // optional autoconnect param
        if (params.get('autoconnect') === '1') sseConnect();
      }
    } catch(e){}
  })();
})();
</script>
</body>
</html>
