<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>Live Preview</title>
<style>
  body { font-family: Arial, sans-serif; background:#111; color:#ddd; margin:0; padding:0; }
  .wrap { display:flex; height:100vh; }
  .left { width:300px; background:#222; padding:12px; box-sizing:border-box; }
  .center { flex:1; display:flex; align-items:center; justify-content:center; background:#000; }
  .right { width:320px; background:#0b0b0b; color:#0f0; padding:8px; box-sizing:border-box; font-family:monospace; font-size:12px; overflow:auto; }
  input,button { width:100%; margin:6px 0; padding:8px; box-sizing:border-box; }
  #preview img { max-width:100%; max-height:100%; border:1px solid #333; display:block; }
  .small { font-size:12px; color:#bbb; }
</style>
</head>
<body>
<div class="wrap">
  <div class="left">
    <h3 style="margin:4px 0 8px 0;color:#fff">Controls</h3>
    <label class="small">Admin token:</label>
    <input id="adminToken" placeholder="ADMIN_TOKEN" />
    <label class="small">Session ID:</label>
    <input id="sessionId" value="default" />
    <button id="connectBtn">Connect SSE</button>
    <button id="disconnectBtn" disabled>Disconnect</button>

    <label class="small">Target URL (optional for start):</label>
    <input id="targetUrl" placeholder="https://www.facebook.com/..." />
    <button id="startBtn">Start</button>
    <button id="stopBtn" disabled>Stop</button>

    <div class="small" style="margin-top:10px">Current page:</div>
    <div id="currentPage" style="word-break:break-all;color:#9cf;margin-top:6px">-</div>
    <div class="small" style="margin-top:10px;color:#888">Preview updates every ~3s (if attached).</div>
  </div>

  <div class="center" id="preview">
    <div style="text-align:center;color:#888">(no screenshot yet)</div>
  </div>

  <div class="right" id="logArea"></div>
</div>

<script>
(function(){
  const adminEl = document.getElementById('adminToken');
  const sessIdEl = document.getElementById('sessionId');
  const connectBtn = document.getElementById('connectBtn');
  const disconnectBtn = document.getElementById('disconnectBtn');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const targetEl = document.getElementById('targetUrl');
  const preview = document.getElementById('preview');
  const logArea = document.getElementById('logArea');
  const currentPageEl = document.getElementById('currentPage');

  let es = null;

  function log(msg, color='#9f9') {
    const t = document.createElement('div');
    t.style.padding='4px 0';
    t.style.color=color;
    t.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
    logArea.appendChild(t);
    logArea.scrollTop = logArea.scrollHeight;
  }

  connectBtn.onclick = () => {
    const token = adminEl.value.trim();
    const sid = sessIdEl.value.trim() || 'default';
    if (!token) return alert('Enter admin token');
    if (es) { log('Already connected'); return; }
    const url = `/events?sessionId=${encodeURIComponent(sid)}`;
    es = new EventSource(url, { withCredentials:false });
    // add token via header not possible with EventSource; we'll send token as query param too
    // so use a quick fetch to /events with header to validate? (server requires requireAdmin) 
    // Workaround: server requireAdmin checks header OR body OR query param 'adminToken'
    // we already appended sessionId only; append adminToken:
    es.close();
    // reconnect with adminToken in query
    const url2 = `/events?sessionId=${encodeURIComponent(sid)}&adminToken=${encodeURIComponent(token)}`;
    es = new EventSource(url2);
    es.addEventListener('ready', e => { log('SSE ready', '#9cf'); disconnectBtn.disabled=false; connectBtn.disabled=true; });
    es.addEventListener('message', e => { /* generic message */ });
    es.addEventListener('screenshot', e => {
      try {
        const d = JSON.parse(e.data);
        if (d && d.b64) {
          preview.innerHTML = '<img src="data:image/png;base64,'+d.b64+'" alt="screenshot">';
        } else if (typeof d === 'string') {
          preview.innerHTML = '<img src="data:image/png;base64,'+d+'" alt="screenshot">';
        }
      } catch(err){ log('screenshot parse err', '#f88'); }
    });
    es.addEventListener('page-url', e => {
      try { const d = JSON.parse(e.data); if (d && d.url) currentPageEl.textContent = d.url; } catch(_) {}
    });
    es.addEventListener('log', e => { try { const d = JSON.parse(e.data); log(d.msg || JSON.stringify(d)); } catch(_){} });
    es.addEventListener('info', e => { try { const d = JSON.parse(e.data); log('info: '+(d.msg||JSON.stringify(d))); } catch(_){} });
    es.addEventListener('warn', e => { try { const d = JSON.parse(e.data); log('warn: '+(d.step||d.msg||JSON.stringify(d)), '#ffb347'); } catch(_){} });
    es.addEventListener('error', e => { try { const d = JSON.parse(e.data); log('error: '+(d.msg||d.error||JSON.stringify(d)), '#f55'); } catch(_){} });
    es.onerror = () => { log('EventSource connection error', '#f55'); };
    log('Connecting SSE...');
  };

  disconnectBtn.onclick = () => {
    if (es) { es.close(); es=null; connectBtn.disabled=false; disconnectBtn.disabled=true; log('Disconnected SSE'); }
  };

  startBtn.onclick = async () => {
    const token = adminEl.value.trim();
    const sid = sessIdEl.value.trim() || 'default';
    const target = targetEl.value.trim();
    if (!token) return alert('Enter admin token');
    const body = { sessionId: sid };
    if (target) body.target = target;
    try {
      const r = await fetch('/start', { method:'POST', headers: {'Content-Type':'application/json','x-admin-token': token}, body: JSON.stringify(body) });
      const j = await r.json();
      if (j && j.ok) { log('Start requested'); startBtn.disabled=true; stopBtn.disabled=false; } else { log('Start failed: '+JSON.stringify(j), '#f55'); }
    } catch (e) { log('Start error: '+String(e), '#f55'); }
  };

  stopBtn.onclick = async () => {
    const token = adminEl.value.trim();
    const sid = sessIdEl.value.trim() || 'default';
    try {
      const r = await fetch('/stop', { method:'POST', headers: {'Content-Type':'application/json','x-admin-token': token}, body: JSON.stringify({ sessionId: sid }) });
      const j = await r.json();
      if (j && j.ok) { log('Stop requested'); startBtn.disabled=false; stopBtn.disabled=true; } else { log('Stop failed: '+JSON.stringify(j), '#f55'); }
    } catch (e) { log('Stop error: '+String(e), '#f55'); }
  };

})();
</script>
</body>
</html>
