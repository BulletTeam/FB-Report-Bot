<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Live Preview</title>
  <style>
    body { font-family: Arial, sans-serif; background:#0f1720; color:#e6eef8; margin:0; padding:12px; }
    #controls { width:240px; float:left; padding-right:10px; }
    #preview { margin-left:260px; max-width:600px; text-align:center; }
    #screenshot { width:360px; height:auto; border:1px solid #333; background:#000; }
    #log { margin-top:12px; font-family: monospace; font-size:12px; color:#b7f3a6; background:#041018; padding:8px; max-height:300px; overflow:auto; }
    label,input{display:block;margin-bottom:6px}
    button{padding:6px 10px;margin:4px}
  </style>
</head>
<body>
  <div id="controls">
    <label>Admin token:</label>
    <input id="token" value="" placeholder="ADMIN_TOKEN" />
    <label>Session ID:</label>
    <input id="session" value="default" />
    <button id="connect">Connect SSE</button>
    <button id="disconnect">Disconnect</button>
    <div style="margin-top:8px;">Current page: <span id="curpage">-</span></div>
    <div style="margin-top:8px;"><button id="startBtn">Start</button><button id="stopBtn">Stop</button></div>
  </div>

  <div id="preview">
    <h3>Live Browser Preview</h3>
    <div id="imgwrap"><img id="screenshot" src="" alt="(no screenshot yet)" /></div>
    <div id="log"></div>
  </div>

<script>
let es = null;
const tokenEl = document.getElementById('token');
const sessEl = document.getElementById('session');
const connectBtn = document.getElementById('connect');
const disconnectBtn = document.getElementById('disconnect');
const img = document.getElementById('screenshot');
const logEl = document.getElementById('log');
const curpage = document.getElementById('curpage');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');

function appendLog(t){
  const d = document.createElement('div');
  d.textContent = '['+new Date().toLocaleTimeString()+'] '+t;
  logEl.appendChild(d);
  logEl.scrollTop = logEl.scrollHeight;
}

connectBtn.onclick = () => {
  if (es) { appendLog('Already connected'); return; }
  const token = encodeURIComponent(tokenEl.value || '');
  const session = encodeURIComponent(sessEl.value || 'default');
  if (!token) { alert('Set admin token'); return; }
  const url = '/events?sessionId='+session+'&adminToken='+token;
  es = new EventSource(url);
  es.addEventListener('ready', e => { appendLog('SSE ready'); });
  es.addEventListener('log', e => { try { const p = JSON.parse(e.data); appendLog('log: '+JSON.stringify(p)); if (p.msg==='page-url' && p.url) { curpage.textContent = p.url; } } catch(_){} });
  es.addEventListener('screenshot', e => {
    try {
      const payload = JSON.parse(e.data);
      // server sends { _noLogFull: true, _heavy: '<base64>', length: N }
      if (payload && payload._heavy) {
        img.src = 'data:image/png;base64,' + payload._heavy;
        appendLog('screenshot received, len='+ (payload.length||0));
      } else {
        // maybe server sends base64 string directly
        if (typeof payload === 'string' && payload.startsWith('iVBOR')) {
          img.src = 'data:image/png;base64,' + payload;
          appendLog('screenshot received (string)');
        } else {
          appendLog('screenshot meta: '+JSON.stringify(payload));
        }
      }
    } catch (err) { appendLog('screenshot parse err'); }
  });
  es.addEventListener('screenshot-meta', e => { try { const p = JSON.parse(e.data); appendLog('screenshot-meta: '+JSON.stringify(p)); } catch(_){} });
  es.addEventListener('cookieStatus', e => { appendLog('cookie: '+e.data); });
  es.addEventListener('info', e => { appendLog('info: '+e.data); });
  es.addEventListener('warn', e => { appendLog('warn: '+e.data); });
  es.addEventListener('error', e => { appendLog('error: '+e.data); });
  appendLog('Connecting SSE -> '+url);
};

disconnectBtn.onclick = () => {
  if (es) { es.close(); es = null; appendLog('SSE disconnected'); }
};

startBtn.onclick = () => {
  const token = tokenEl.value || '';
  const session = sessEl.value || 'default';
  if (!token) return alert('set token');
  fetch('/start', {
    method:'POST',
    headers:{ 'Content-Type':'application/json', 'x-admin-token': token },
    body: JSON.stringify({ sessionId: session, targetUrl: curpage.textContent || 'https://www.facebook.com/' })
  }).then(r=>r.json()).then(j=>appendLog('start -> '+JSON.stringify(j))).catch(e=>appendLog('start err'));
};

stopBtn.onclick = () => {
  const token = tokenEl.value || '';
  const session = sessEl.value || 'default';
  if (!token) return alert('set token');
  fetch('/stop', { method:'POST', headers:{ 'Content-Type':'application/json', 'x-admin-token': token }, body: JSON.stringify({ sessionId: session }) })
    .then(r=>r.json()).then(j=>appendLog('stop -> '+JSON.stringify(j))).catch(e=>appendLog('stop err'));
};
</script>
</body>
</html>
